@startuml
title Provider-side Orderbook Assembly with Checksum Verification

box "Combination (Provider-side components)" #LightBlue
  participant "WS (coder/websocket)" as WS
  participant "REST (snapshot)" as REST
  participant "Book Assembler" as BA
  participant "Parser" as Parser
end box

participant "Dispatcher" as Disp

WS -> Parser : Raw frame
Parser -> BA : BookUpdatePayload{symbol=BTC-USDT, seq=1001, checksum}
BA -> BA : Apply update; verify checksum

WS -> Parser : Raw frame
Parser -> BA : BookUpdatePayload{symbol=BTC-USDT, seq=1003, checksum}
BA -> BA : Buffer seq=1003

REST -> Parser : Snapshot response
Parser -> BA : BookSnapshotPayload{symbol=BTC-USDT, seq=1000, checksum}
BA -> BA : Apply snapshot; verify checksum
BA -> BA : Apply buffered seq=1003; verify final checksum

WS -> Parser : Raw frame
Parser -> BA : BookUpdatePayload{symbol=BTC-USDT, seq=1002, checksum}
BA -> BA : Apply seq=1002; verify checksum

alt Checksum verification fails
  BA -> BA : Reject event; emit error
end

BA -> Disp : Canonical BookUpdate/BookSnapshot events
@enduml
